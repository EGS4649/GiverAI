<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Debug Solution</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        .debug-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(0, 255, 255, 0.2);
        }
        
        .debug-section {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .debug-title {
            color: #00ffff;
            font-size: 1.5rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #6c757d;
        }
        
        .status-success {
            background: #28a745;
        }
        
        .status-error {
            background: #dc3545;
        }
        
        .status-warning {
            background: #ffc107;
        }
        
        .debug-output {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
            margin-top: 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, #00ffff, #0080ff);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 10px 10px 0;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .code-block {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            overflow-x: auto;
        }
        
        .code-block pre {
            margin: 0;
            color: #ffffff;
        }
        
        .highlight {
            background: rgba(255, 255, 0, 0.2);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .error-log {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .success-log {
            color: #51cf66;
            background: rgba(81, 207, 102, 0.1);
            border: 1px solid rgba(81, 207, 102, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .warning-log {
            color: #ffd43b;
            background: rgba(255, 212, 59, 0.1);
            border: 1px solid rgba(255, 212, 59, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .fix-instructions {
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .fix-instructions h3 {
            color: #00ffff;
            margin-top: 0;
        }
        
        .fix-step {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            border-left: 4px solid #00ffff;
        }
        
        .api-test-result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1 style="text-align: center; color: #00ffff; margin-bottom: 30px;">
            üîß Admin Dashboard Debug Tool
        </h1>
        
        <!-- Connection Status -->
        <div class="debug-section">
            <div class="debug-title">
                <span class="status-indicator" id="connectionStatus"></span>
                üåê Backend Connection Status
            </div>
            <button class="btn" onclick="testBackendConnection()">Test Connection</button>
            <button class="btn" onclick="testAdminAPI()">Test Admin API</button>
            <div class="debug-output" id="connectionOutput">Click "Test Connection" to check backend status...</div>
        </div>
        
        <!-- API Endpoints -->
        <div class="debug-section">
            <div class="debug-title">
                <span class="status-indicator" id="apiStatus"></span>
                üì° API Endpoints Test
            </div>
            <button class="btn" onclick="testAllAPIs()">Test All APIs</button>
            <button class="btn" onclick="testUserAPI()">Test /admin/api/users</button>
            <div class="debug-output" id="apiOutput">Ready to test API endpoints...</div>
        </div>
        
        <!-- Database Status -->
        <div class="debug-section">
            <div class="debug-title">
                <span class="status-indicator" id="dbStatus"></span>
                üóÑÔ∏è Database Status
            </div>
            <button class="btn" onclick="testDatabase()">Test Database</button>
            <button class="btn" onclick="checkUserTable()">Check Users Table</button>
            <div class="debug-output" id="dbOutput">Database test not run yet...</div>
        </div>
        
        <!-- JavaScript Console -->
        <div class="debug-section">
            <div class="debug-title">
                <span class="status-indicator" id="jsStatus"></span>
                üîç Browser Console
            </div>
            <button class="btn" onclick="checkBrowserErrors()">Check Browser Errors</button>
            <button class="btn" onclick="simulateUserLoad()">Simulate User Load</button>
            <div class="debug-output" id="jsOutput">No JavaScript errors captured yet...</div>
        </div>
        
        <!-- Fix Instructions -->
        <div class="fix-instructions">
            <h3>üõ†Ô∏è Common Issues & Solutions</h3>
            
            <div class="fix-step">
                <strong>Issue 1: Missing API Route</strong>
                <p>If your main.py doesn't have <code>/admin/api/users</code> endpoint, add this code:</p>
                <div class="code-block">
<pre># Add this to your main.py
from sqlalchemy.orm import Session

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/admin/api/users")
async def get_users_api(
    request: Request,
    limit: int = Query(100),
    page: int = Query(1),
    search: str = Query(""),
    status: str = Query(""),
    plan: str = Query(""),
    db: Session = Depends(get_db)
):
    """API endpoint to get users for admin dashboard"""
    try:
        # Check admin authorization
        user = get_optional_user(request)
        if not user or user.email not in ["support@giverai.me"]:
            raise HTTPException(status_code=403, detail="Admin access required")
        
        query = db.query(User)
        
        # Apply filters
        if search:
            query = query.filter(
                (User.username.ilike(f"%{search}%")) |
                (User.email.ilike(f"%{search}%"))
            )
        
        if status == "suspended":
            query = query.filter(User.is_suspended == True)
        elif status == "active":
            query = query.filter(User.is_suspended == False)
            
        if plan:
            query = query.filter(User.plan == plan)
        
        total_users = query.count()
        
        # Pagination
        offset = (page - 1) * limit
        users = query.offset(offset).limit(limit).all()
        
        # Format users data
        users_data = []
        for user in users:
            users_data.append({
                "id": user.id,
                "username": user.username,
                "email": user.email,
                "plan": user.plan,
                "is_suspended": user.is_suspended,
                "suspension_reason": user.suspension_reason,
                "created_at": user.created_at.isoformat() if user.created_at else None,
                "last_login": user.last_login.isoformat() if user.last_login else None,
                "is_active": user.is_active
            })
        
        return JSONResponse({
            "success": True,
            "users": users_data,
            "total": total_users,
            "page": page,
            "limit": limit
        })
        
    except Exception as e:
        print(f"Error in get_users_api: {str(e)}")
        return JSONResponse({
            "success": False,
            "error": str(e),
            "users": [],
            "total": 0
        }, status_code=500)</pre>
                </div>
            </div>
            
            <div class="fix-step">
                <strong>Issue 2: Missing Admin Dashboard Route</strong>
                <p>Ensure you have the admin dashboard route:</p>
                <div class="code-block">
<pre>@app.get("/admin/dashboard", response_class=HTMLResponse)
async def admin_dashboard(
    request: Request,
    success: str = Query(None),
    error: str = Query(None),
    db: Session = Depends(get_db)
):
    """Admin dashboard page"""
    try:
        # Check if user is admin
        user = get_optional_user(request)
        if not user or user.email not in ["support@giverai.me"]:
            raise HTTPException(status_code=403, detail="Admin access required")
        
        # Get statistics
        total_users = db.query(User).count()
        suspended_count = db.query(User).filter(User.is_suspended == True).count()
        
        # Recent signups (last 7 days)
        seven_days_ago = datetime.utcnow() - timedelta(days=7)
        recent_signups = db.query(User).filter(User.created_at >= seven_days_ago).count()
        
        # Active today (logged in last 24 hours)
        one_day_ago = datetime.utcnow() - timedelta(days=1)
        active_today = db.query(User).filter(User.last_login >= one_day_ago).count()
        
        return templates.TemplateResponse("admin/dashboard.html", {
            "request": request,
            "user": user,
            "total_users": total_users,
            "suspended_count": suspended_count,
            "recent_signups": recent_signups,
            "active_today": active_today,
            "success": success,
            "error": error
        })
        
    except Exception as e:
        print(f"Admin dashboard error: {str(e)}")
        raise HTTPException(status_code=500, detail="Admin dashboard error")</pre>
                </div>
            </div>
            
            <div class="fix-step">
                <strong>Issue 3: CORS or Authorization</strong>
                <p>If you get 403/401 errors, check your authentication:</p>
                <div class="code-block">
<pre># Make sure your get_optional_user function works
def get_optional_user(request: Request):
    try:
        token = request.cookies.get("access_token")
        if not token:
            return None
        
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        username = payload.get("sub")
        if not username:
            return None
        
        db = SessionLocal()
        try:
            user = db.query(User).filter(User.username == username).first()
            return user
        finally:
            db.close()
            
    except Exception as e:
        print(f"Auth error: {e}")
        return None</pre>
                </div>
            </div>
            
            <div class="fix-step">
                <strong>Issue 4: Database Connection</strong>
                <p>Verify your database connection and User model:</p>
                <div class="code-block">
<pre># Add this test route temporarily to check DB
@app.get("/test-db")
async def test_database_connection(db: Session = Depends(get_db)):
    try:
        # Simple query to test connection
        user_count = db.query(User).count()
        sample_user = db.query(User).first()
        
        return {
            "database_connected": True,
            "total_users": user_count,
            "sample_user": {
                "id": sample_user.id if sample_user else None,
                "username": sample_user.username if sample_user else None,
                "email": sample_user.email if sample_user else None
            } if sample_user else None
        }
    except Exception as e:
        return {
            "database_connected": False,
            "error": str(e)
        }</pre>
                </div>
            </div>
        </div>
        
        <!-- Manual Debug -->
        <div class="debug-section">
            <div class="debug-title">
                <span class="status-indicator" id="manualStatus"></span>
                üîß Manual Debug
            </div>
            <button class="btn" onclick="checkNetworkTab()">Check Network Tab</button>
            <button class="btn" onclick="inspectElement()">Inspect Element</button>
            <button class="btn btn-danger" onclick="clearAllData()">Clear Browser Data</button>
            <div class="debug-output" id="manualOutput">Manual debugging instructions...</div>
        </div>
    </div>

    <script>
        // Capture console errors
        const originalConsoleError = console.error;
        const consoleErrors = [];
        
        console.error = function(...args) {
            consoleErrors.push(`[${new Date().toISOString()}] ${args.join(' ')}`);
            originalConsoleError.apply(console, args);
        };
        
        // Test backend connection
        async function testBackendConnection() {
            const output = document.getElementById('connectionOutput');
            const status = document.getElementById('connectionStatus');
            
            output.textContent = 'Testing backend connection...';
            
            try {
                const response = await fetch('/');
                if (response.ok) {
                    output.textContent = `‚úÖ Backend connected successfully!\nStatus: ${response.status}\nResponse headers: ${JSON.stringify([...response.headers], null, 2)}`;
                    status.className = 'status-indicator status-success';
                } else {
                    output.textContent = `‚ö†Ô∏è Backend responded with status: ${response.status}`;
                    status.className = 'status-indicator status-warning';
                }
            } catch (error) {
                output.textContent = `‚ùå Backend connection failed: ${error.message}`;
                status.className = 'status-indicator status-error';
            }
        }
        
        // Test admin API specifically
        async function testAdminAPI() {
            const output = document.getElementById('connectionOutput');
            
            try {
                const response = await fetch('/admin/api/users?limit=5');
                const data = await response.json();
                
                output.textContent = `Admin API Response (${response.status}):\n${JSON.stringify(data, null, 2)}`;
                
                if (response.ok && data.success) {
                    document.getElementById('connectionStatus').className = 'status-indicator status-success';
                } else {
                    document.getElementById('connectionStatus').className = 'status-indicator status-warning';
                }
            } catch (error) {
                output.textContent = `‚ùå Admin API test failed: ${error.message}`;
                document.getElementById('connectionStatus').className = 'status-indicator status-error';
            }
        }
        
        // Test all APIs
        async function testAllAPIs() {
            const output = document.getElementById('apiOutput');
            const status = document.getElementById('apiStatus');
            
            output.textContent = 'Testing all API endpoints...\n';
            
            const endpoints = [
                '/admin/api/users',
                '/admin/dashboard',
                '/test-db'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint);
                    output.textContent += `\n${endpoint}: ${response.status} - ${response.ok ? '‚úÖ' : '‚ùå'}`;
                    
                    if (endpoint === '/admin/api/users' && response.ok) {
                        const data = await response.json();
                        output.textContent += `\n  Users returned: ${data.users ? data.users.length : 0}`;
                        output.textContent += `\n  Total users: ${data.total || 0}`;
                    }
                } catch (error) {
                    output.textContent += `\n${endpoint}: ERROR - ${error.message}`;
                }
            }
            
            status.className = 'status-indicator status-success';
        }
        
        // Test specific user API
        async function testUserAPI() {
            const output = document.getElementById('apiOutput');
            
            try {
                output.textContent = 'Testing /admin/api/users endpoint...';
                
                const response = await fetch('/admin/api/users?limit=10');
                const text = await response.text();
                
                output.textContent = `Response Status: ${response.status}\n`;
                output.textContent += `Response Headers: ${JSON.stringify([...response.headers], null, 2)}\n\n`;
                
                try {
                    const data = JSON.parse(text);
                    output.textContent += `Parsed JSON Response:\n${JSON.stringify(data, null, 2)}`;
                } catch {
                    output.textContent += `Raw Response (not JSON):\n${text}`;
                }
                
            } catch (error) {
                output.textContent = `‚ùå User API test failed: ${error.message}\nStack: ${error.stack}`;
            }
        }
        
        // Test database
        async function testDatabase() {
            const output = document.getElementById('dbOutput');
            const status = document.getElementById('dbStatus');
            
            try {
                const response = await fetch('/test-db');
                const data = await response.json();
                
                output.textContent = `Database Test Results:\n${JSON.stringify(data, null, 2)}`;
                
                if (data.database_connected) {
                    status.className = 'status-indicator status-success';
                } else {
                    status.className = 'status-indicator status-error';
                }
            } catch (error) {
                output.textContent = `‚ùå Database test failed: ${error.message}`;
                status.className = 'status-indicator status-error';
            }
        }
        
        // Check user table specifically
        async function checkUserTable() {
            const output = document.getElementById('dbOutput');
            
            try {
                // This would need a specific endpoint
                const response = await fetch('/admin/api/users?limit=1');
                const data = await response.json();
                
                if (data.users && data.users.length > 0) {
                    output.textContent = `Users table structure:\n${JSON.stringify(data.users[0], null, 2)}`;
                } else {
                    output.textContent = 'No users found in database or table access error';
                }
            } catch (error) {
                output.textContent = `‚ùå User table check failed: ${error.message}`;
            }
        }
        
        // Check browser errors
        function checkBrowserErrors() {
            const output = document.getElementById('jsOutput');
            const status = document.getElementById('jsStatus');
            
            if (consoleErrors.length > 0) {
                output.textContent = `Found ${consoleErrors.length} console errors:\n\n${consoleErrors.join('\n\n')}`;
                status.className = 'status-indicator status-error';
            } else {
                output.textContent = '‚úÖ No console errors detected';
                status.className = 'status-indicator status-success';
            }
            
            // Also show any network errors from failed requests
            output.textContent += '\n\nChecking for failed network requests...';
            
            // Check performance entries for failed requests
            const entries = performance.getEntriesByType('navigation');
            if (entries.length > 0) {
                output.textContent += `\nNavigation timing: ${JSON.stringify(entries[0], null, 2)}`;
            }
        }
        
        // Simulate the user loading process
        async function simulateUserLoad() {
            const output = document.getElementById('jsOutput');
            
            output.textContent = 'Simulating user load process...\n';
            
            // Step 1: Check if loadUsers function exists
            if (typeof loadUsers === 'function') {
                output.textContent += '‚úÖ loadUsers function exists\n';
                
                try {
                    // Try to call loadUsers
                    await loadUsers();
                    output.textContent += '‚úÖ loadUsers executed successfully\n';
                } catch (error) {
                    output.textContent += `‚ùå loadUsers failed: ${error.message}\n`;
                }
            } else {
                output.textContent += '‚ùå loadUsers function not found\n';
                output.textContent += 'This means the admin dashboard JavaScript is not loaded correctly\n';
            }
            
            // Step 2: Check DOM elements
            const elements = ['usersTableBody', 'totalUsers', 'userCount'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    output.textContent += `‚úÖ Element ${id} found\n`;
                } else {
                    output.textContent += `‚ùå Element ${id} not found\n`;
                }
            });
            
            // Step 3: Try direct fetch
            try {
                output.textContent += '\nTrying direct API call...\n';
                const response = await fetch('/admin/api/users?limit=5');
                const data = await response.json();
                output.textContent += `API Response: ${JSON.stringify(data, null, 2)}\n`;
            } catch (error) {
                output.textContent += `API Error: ${error.message}\n`;
            }
        }
        
        // Manual debug instructions
        function checkNetworkTab() {
            const output = document.getElementById('manualOutput');
            
            output.textContent = `üîç MANUAL DEBUG STEPS:

1. Open Browser Developer Tools (F12)
2. Go to the Network tab
3. Refresh your admin dashboard page
4. Look for these requests:
   - GET /admin/dashboard (should be 200)
   - GET /admin/api/users (should be 200)

5. If you see 404 errors:
   - The API endpoints don't exist in your backend
   - Add the missing routes to main.py

6. If you see 403/401 errors:
   - Authentication issue
   - Make sure you're logged in as admin

7. If you see 500 errors:
   - Server error, check your terminal/logs
   - Database connection issues

8. If requests are successful but no users show:
   - Check the JSON response structure
   - Look for JavaScript errors in Console tab`;
        }
        
        function inspectElement() {
            const output = document.getElementById('manualOutput');
            
            output.textContent = `üîç ELEMENT INSPECTION:

1. Right-click on the empty users table
2. Select "Inspect Element"
3. Look for the table body with ID "usersTableBody"
4. Check if it contains any <tr> elements
5. If empty, the JavaScript isn't populating it
6. If has error message, there's an API issue

Common issues:
- Table shows "Failed to load users" = API error
- Table completely empty = JavaScript not running
- Table shows loading state = API call hanging

Check browser Console tab for error messages.`;
        }
        
        function clearAllData() {
            const output = document.getElementById('manualOutput');
            
            if (confirm('This will clear all browser data for this site. Continue?')) {
                // Clear localStorage
                localStorage.clear();
                
                // Clear sessionStorage
                sessionStorage.clear();
                
                // Clear cookies (limited by same-origin policy)
                document.cookie.split(";").forEach(function(c) { 
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                });
                
                output.textContent = '‚úÖ Browser data cleared. Please refresh the page and try again.';
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }
        
        // Auto-run initial tests
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testBackendConnection();
            }, 500);
        });
        
        // Listen for unhandled promise rejections
        window.addEventListener('unhandledrejection', event => {
            consoleErrors.push(`[${new Date().toISOString()}] Unhandled Promise Rejection: ${event.reason}`);
        });
    </script>
</body>
</html>
